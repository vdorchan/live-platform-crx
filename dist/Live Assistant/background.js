!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";const e=[{key:"topNum",cubeId:"tblive_rpt_ind_trend",toSaveDataProp:"liveMaxOnlineDataStr",param:'{"param":"{"queryId":"0|9616773|undefined","cubeId":"tblive_rpt_ind_trend","queryDetail":false,"startTime":"2020-07-26 20:00:01","endTime":"2020-07-26 23:00:46","timeType":2,"sign":null,"limit":1,"row":"[]","measure":"[{"name":"峰值PM在线人数","isMeasure":true}]","column":"[]","orders":"[]","filter":"[{"name":"开播日期分区字段yyyymmdd","type":"dimension","isMeasure":false,"values":["20200726"],"oper":"="},{"name":"直播间id","type":"dimension","isMeasure":false,"values":["272922348257"],"oper":"="},{"name":"主播id","type":"dimension","isMeasure":false,"values":[2081592196],"oper":"="}]","extra":null}","innerId":""}',toSaveApi:"tbMonitorLiveEffect/saveLiveMaxOnlineData"},{cubeId:"tblive_rpt_abstract_indicator",toSaveDataProp:"accessAndTransformDataStr",param:'{"param":"{"queryId":"1|95654043|undefined","cubeId":"tblive_rpt_abstract_indicator","queryDetail":false,"startTime":"2020-07-26 20:00:01","endTime":"2020-07-26 23:00:46","timeType":2,"sign":null,"limit":1,"row":"[]","measure":"[{"name":"观看次数","isMeasure":true},{"name":"额外奖励流量","isMeasure":true},{"name":"计算平均在线时长","isMeasure":true},{"name":"引导进店次数","isMeasure":true},{"name":"新增粉丝数","isMeasure":true},{"name":"PM观看次数","isMeasure":true},{"name":"PM在线人数","isMeasure":true},{"name":"计算封面图点击率","isMeasure":true},{"name":"直播间浏览次数_粉丝占比","isMeasure":true},{"name":"引导进店次数_粉丝占比","isMeasure":true}]","column":"[]","orders":"[]","filter":"[{"name":"开播日期分区字段yyyymmdd","type":"dimension","isMeasure":false,"values":["20200726"],"oper":"="},{"name":"直播间id","type":"dimension","isMeasure":false,"values":["272922348257"],"oper":"="},{"name":"主播id","type":"dimension","isMeasure":false,"values":[2081592196],"oper":"="}]","extra":null}","innerId":""}',toSaveApi:"tbMonitorLiveEffect/saveAccessAndTransformData"},{cubeId:"dws_mit_cbot_slr_lime_rpt_ov_deal",toSaveDataProp:"liveSummaryOrderDataStr",param:'{"param":"{"queryId":"2|87451842|undefined","cubeId":"dws_mit_cbot_slr_lime_rpt_ov_deal","queryDetail":false,"startTime":"2020-07-26 20:00:01","endTime":"2020-07-26 23:00:46","timeType":2,"sign":null,"limit":1,"row":"[]","measure":"[{"name":"引导成交笔数","isMeasure":true},{"name":"引导成交笔数_粉丝占比","isMeasure":true},{"name":"引导成交金额","isMeasure":true},{"name":"引导成交金额_粉丝占比","isMeasure":true}]","column":"[]","orders":"[]","filter":"[{"name":"开播日期分区字段yyyymmdd","type":"dimension","isMeasure":false,"values":["20200726"],"oper":"="},{"name":"直播间id","type":"dimension","isMeasure":false,"values":["272922348257"],"oper":"="},{"name":"主播id","type":"dimension","isMeasure":false,"values":[2081592196],"oper":"="}]","extra":null}","innerId":""}',toSaveApi:"tbMonitorLiveEffect/saveLiveSummaryOrderData"},{cubeId:"tblive_rpt_abstract_indicator",toSaveDataProp:"liveAvgOnlineData",param:'{"param":"{"queryId":"3|21472062|undefined","cubeId":"tblive_rpt_abstract_indicator","queryDetail":false,"startTime":"2020-07-26 20:00:01","endTime":"2020-07-26 23:00:46","timeType":2,"sign":null,"limit":1,"row":"[]","measure":"[{"name":"计算平均在线时长","isMeasure":true}]","column":"[]","orders":"[]","filter":"[{"name":"是否粉丝","type":"dimension","isMeasure":false,"values":["Y"],"oper":"="},{"name":"开播日期分区字段yyyymmdd","type":"dimension","isMeasure":false,"values":["20200726"],"oper":"="},{"name":"直播间id","type":"dimension","isMeasure":false,"values":["272922348257"],"oper":"="},{"name":"主播id","type":"dimension","isMeasure":false,"values":[2081592196],"oper":"="}]","extra":null}","innerId":""}',toSaveApi:"tbMonitorLiveEffect/saveLiveAvgOnlineData"},{cubeId:"tblive_rpt_ind_trend",toSaveDataProp:"liveRealtimeTendDataStr",param:'{"param":"{"queryId":"4|65884581|undefined","cubeId":"tblive_rpt_ind_trend","queryDetail":false,"startTime":"2020-07-26 20:00:01","endTime":"2020-07-26 23:00:46","timeType":2,"sign":null,"limit":2000,"row":"[{"name":"时间精确到分钟","isMeasure":false}]","measure":"[{"name":"PM观看次数","isMeasure":true}]","column":"[]","orders":"[]","filter":"[{"name":"开播日期分区字段yyyymmdd","type":"dimension","isMeasure":false,"values":["20200726"],"oper":"="},{"name":"直播间id","type":"dimension","isMeasure":false,"values":["272922348257"],"oper":"="},{"name":"主播id","type":"dimension","isMeasure":false,"values":[2081592196],"oper":"="}]","extra":null}","innerId":""}',toSaveApi:"tbMonitorRealtimeTend/saveRealtimeTendData"},{cubeId:"tblive_rpt_ind_trend",toSaveDataProp:"liveRealtimeTendDataStr",param:'{"param":"{"queryId":"5|30278359|undefined","cubeId":"tblive_rpt_ind_trend","queryDetail":false,"startTime":"2020-07-26 20:00:01","endTime":"2020-07-26 23:00:46","timeType":2,"sign":null,"limit":2000,"row":"[{"name":"时间精确到分钟","isMeasure":false}]","measure":"[{"name":"观看次数","isMeasure":true}]","column":"[]","orders":"[]","filter":"[{"name":"开播日期分区字段yyyymmdd","type":"dimension","isMeasure":false,"values":["20200726"],"oper":"="},{"name":"直播间id","type":"dimension","isMeasure":false,"values":["272922348257"],"oper":"="},{"name":"主播id","type":"dimension","isMeasure":false,"values":[2081592196],"oper":"="}]","extra":null}","innerId":""}',toSaveApi:"tbMonitorRealtimeTend/saveRealtimeTendData"},{cubeId:"tblive_rpt_ind_trend",toSaveDataProp:"liveRealtimeTendDataStr",param:'{"param":"{"queryId":"6|93131114|undefined","cubeId":"tblive_rpt_ind_trend","queryDetail":false,"startTime":"2020-07-26 20:00:01","endTime":"2020-07-26 23:00:46","timeType":2,"sign":null,"limit":2000,"row":"[{"name":"时间精确到分钟","isMeasure":false}]","measure":"[{"name":"PM在线人数","isMeasure":true}]","column":"[]","orders":"[]","filter":"[{"name":"开播日期分区字段yyyymmdd","type":"dimension","isMeasure":false,"values":["20200726"],"oper":"="},{"name":"直播间id","type":"dimension","isMeasure":false,"values":["272922348257"],"oper":"="},{"name":"主播id","type":"dimension","isMeasure":false,"values":[2081592196],"oper":"="}]","extra":null}","innerId":""}',toSaveApi:"tbMonitorRealtimeTend/saveRealtimeTendData"},{cubeId:"mit_cbot_slr_lime_rpt_ov_trend_deal",toSaveDataProp:"liveRealtimeTendDataStr",param:'{"param":"{"queryId":"7|5760439|undefined","cubeId":"mit_cbot_slr_lime_rpt_ov_trend_deal","queryDetail":false,"startTime":"2020-07-26 20:00:01","endTime":"2020-07-26 23:00:46","timeType":2,"sign":null,"limit":2000,"row":"[{"name":"时间精确到分钟","isMeasure":false}]","measure":"[{"name":"引导成交金额","isMeasure":true}]","column":"[]","orders":"[]","filter":"[{"name":"开播日期分区字段yyyymmdd","type":"dimension","isMeasure":false,"values":["20200726"],"oper":"="},{"name":"直播间id","type":"dimension","isMeasure":false,"values":["272922348257"],"oper":"="},{"name":"主播id","type":"dimension","isMeasure":false,"values":[2081592196],"oper":"="}]","extra":null}","innerId":""}',toSaveApi:"tbMonitorRealtimeTend/saveRealtimeTendData"},{cubeId:"tblive_rpt_ind_trend",toSaveDataProp:"liveRealtimeTendDataStr",param:'{"param":"{"queryId":"8|5024396|undefined","cubeId":"tblive_rpt_ind_trend","queryDetail":false,"startTime":"2020-07-26 20:00:01","endTime":"2020-07-26 23:00:46","timeType":2,"sign":null,"limit":2000,"row":"[{"name":"时间精确到分钟","isMeasure":false}]","measure":"[{"name":"引导进店次数","isMeasure":true}]","column":"[]","orders":"[]","filter":"[{"name":"开播日期分区字段yyyymmdd","type":"dimension","isMeasure":false,"values":["20200726"],"oper":"="},{"name":"直播间id","type":"dimension","isMeasure":false,"values":["272922348257"],"oper":"="},{"name":"主播id","type":"dimension","isMeasure":false,"values":[2081592196],"oper":"="}]","extra":null}","innerId":""}',toSaveApi:"tbMonitorRealtimeTend/saveRealtimeTendData"},{cubeId:"tblive_rpt_ind_trend",toSaveDataProp:"liveRealtimeTendDataStr",param:'{"param":"{"queryId":"9|64096482|undefined","cubeId":"tblive_rpt_ind_trend","queryDetail":false,"startTime":"2020-07-26 20:00:01","endTime":"2020-07-26 23:00:46","timeType":2,"sign":null,"limit":2000,"row":"[{"name":"时间精确到分钟","isMeasure":false}]","measure":"[{"name":"新增粉丝数","isMeasure":true}]","column":"[]","orders":"[]","filter":"[{"name":"开播日期分区字段yyyymmdd","type":"dimension","isMeasure":false,"values":["20200726"],"oper":"="},{"name":"直播间id","type":"dimension","isMeasure":false,"values":["272922348257"],"oper":"="},{"name":"主播id","type":"dimension","isMeasure":false,"values":[2081592196],"oper":"="}]","extra":null}","innerId":""}',toSaveApi:"tbMonitorRealtimeTend/saveRealtimeTendData"},{cubeId:"tblive_rpt_source_trend",toSaveDataProp:"liveSourceChannelDataStr",param:'{"param":"{"queryId":"10|51041760|undefined","cubeId":"tblive_rpt_source_trend","queryDetail":false,"startTime":"2020-07-26 20:00:01","endTime":"2020-07-26 23:00:46","timeType":2,"sign":null,"limit":2000,"row":"[{"name":"时间精确到分钟","isMeasure":false},{"name":"直播间来源","isMeasure":false}]","measure":"[{"name":"观看次数","isMeasure":true}]","column":"[]","orders":"[]","filter":"[{"name":"开播日期分区字段yyyymmdd","type":"dimension","isMeasure":false,"values":["20200726"],"oper":"="},{"name":"直播间id","type":"dimension","isMeasure":false,"values":["272922348257"],"oper":"="},{"name":"主播id","type":"dimension","isMeasure":false,"values":[2081592196],"oper":"="}]","extra":null}","innerId":""}',toSaveApi:"tbMonitorSourceChannel/saveSourceChannelData"},{cubeId:"tblive_rpt_item_indicator",toSaveDataProp:"productViewDataStr",param:'{"param":"{"queryId":"11|33606177|undefined","cubeId":"tblive_rpt_item_indicator","queryDetail":false,"startTime":"2020-07-26 20:00:01","endTime":"2020-07-26 23:00:46","timeType":2,"sign":null,"limit":2000,"row":"[{"name":"商品id","isMeasure":false},{"name":"主图地址","isMeasure":false},{"name":"商品标题","isMeasure":false}]","measure":"[{"name":"商品点击次数","isMeasure":true},{"name":"商品点击人数","isMeasure":true}]","column":"[]","orders":"[]","filter":"[{"name":"开播日期分区字段yyyymmdd","type":"dimension","isMeasure":false,"values":["20200726"],"oper":"="},{"name":"直播间id","type":"dimension","isMeasure":false,"values":["272922348257"],"oper":"="},{"name":"主播id","type":"dimension","isMeasure":false,"values":[2081592196],"oper":"="}]","extra":null}","innerId":""}',toSaveApi:"tbMonitorLiveItem/saveProductViewData"},{cubeId:"dws_mit_cbot_slr_lime_rpt_itm_deal",toSaveDataProp:"productOrderDataStr",param:'{"param":"{"queryId":"12|83415245|undefined","cubeId":"dws_mit_cbot_slr_lime_rpt_itm_deal","queryDetail":false,"startTime":"2020-07-26 20:00:01","endTime":"2020-07-26 23:00:46","timeType":2,"sign":null,"limit":2000,"row":"[{"name":"商品id","isMeasure":false}]","measure":"[{"name":"引导成交件数","isMeasure":true},{"name":"引导成交金额","isMeasure":true}]","column":"[]","orders":"[]","filter":"[{"name":"开播日期分区字段yyyymmdd","type":"dimension","isMeasure":false,"values":["20200726"],"oper":"="},{"name":"直播间id","type":"dimension","isMeasure":false,"values":["272922348257"],"oper":"="},{"name":"主播id","type":"dimension","isMeasure":false,"values":[2081592196],"oper":"="}]","extra":null}","innerId":""}',toSaveApi:"tbMonitorLiveItem/saveProductOrderData"}],t={};e.forEach(e=>{t[e.param.replace(/[0-9undefined]/g,"")]={cubeId:e.cubeId,toSaveDataProp:e.toSaveDataProp,toSaveApi:e.toSaveApi}});const i="https://liveplatform.taobao.com/live/liveList.htm",a="https://live.baowenonline.com",s="https://testlive.baowenonline.com",r="SAVE_DATA",n="INIT_LIVE_LIST",o="STORE_LIVE_LIST",l="GET_LIVE_LIST_FROM_STORE",u="START_LIVE_SYNC",d="SINGLE_LIVE_SYNC",m="LIVE_PROGRESS",c="SYNC_TAB_REMOVED";"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;!function(e,t){e(t={exports:{}},t.exports)}((function(e,t){e.exports=function(){var e=/^v?(?:\d+)(\.(?:[x*]|\d+)(\.(?:[x*]|\d+)(\.(?:[x*]|\d+))?(?:-[\da-z\-]+(?:\.[\da-z\-]+)*)?(?:\+[\da-z\-]+(?:\.[\da-z\-]+)*)?)?)?$/i;function t(e){var t,i,a=e.replace(/^v/,"").replace(/\+.*$/,""),s=-1===(t=a).indexOf(i="-")?t.length:t.indexOf(i),r=a.substring(0,s).split(".");return r.push(a.substring(s+1)),r}function i(e){return isNaN(Number(e))?e:Number(e)}function a(t){if("string"!=typeof t)throw new TypeError("Invalid argument expected string");if(!e.test(t))throw Error("Invalid argument not valid semver ('"+t+"' received)")}function s(e,s){[e,s].forEach(a);for(var r=t(e),n=t(s),o=0;Math.max(r.length-1,n.length-1)>o;o++){var l=parseInt(r[o]||0,10),u=parseInt(n[o]||0,10);if(l>u)return 1;if(u>l)return-1}var d=r[r.length-1],m=n[n.length-1];if(d&&m){var c=d.split(".").map(i),p=m.split(".").map(i);for(o=0;Math.max(c.length,p.length)>o;o++){if(void 0===c[o]||"string"==typeof p[o]&&"number"==typeof c[o])return-1;if(void 0===p[o]||"string"==typeof c[o]&&"number"==typeof p[o])return 1;if(c[o]>p[o])return 1;if(p[o]>c[o])return-1}}else if(d||m)return d?-1:1;return 0}var r=[">",">=","=","<","<="],n={">":[1],">=":[0,1],"=":[0],"<=":[-1,0],"<":[-1]};return s.validate=function(t){return"string"==typeof t&&e.test(t)},s.compare=function(e,t,i){!function(e){if("string"!=typeof e)throw new TypeError("Invalid operator type, expected string but got "+typeof e);if(-1===r.indexOf(e))throw new TypeError("Invalid operator, expected one of "+r.join("|"))}(i);var a=s(e,t);return n[i].indexOf(a)>-1},s}()}));let p,f=0;function v(e){const t={"&amp;":"&","&apos;":"'","&gt;":">","&lt;":"<","&quot;":'"'},i=RegExp("("+Object.keys(t).join("|")+")","g");return e.replace(i,(function(e){return t[e]}))}async function h(e,t){const i=await fetch(e,{referrerPolicy:"no-referrer-when-downgrade",body:null,method:"GET",mode:"cors",credentials:"include",...t});if(/^https:\/\/login.taobao.com\/member\/login\.jhtml/.test(i.url))throw Error("NOT_LOGIN");if(200===i.status)return i.json();throw Error("response error: "+i.status)}async function y(e){return h(e)}async function g(){if(f>3)throw Error("refresh token too many times");++f;const e=await h("https://testlive.baowenonline.com/api/sl-schedule-lives/token/get");p=e.data,console.log("refreshToken",p)}async function b(e,t,i){p||await g();const a=await h("http://molitest-tbtest23.willbe.net.cn/tblive/"+e,{body:JSON.stringify(t),method:"POST",headers:{accountId:350,sessionId:p,"content-type":"application/json"},referrer:"no-referrer"});return-1===a.status&&"身份无效！"===a.msg?(await g(),b(e,t)):(f=0,a)}const I={getIndex:e=>new Promise(t=>chrome.tabs.query({},i=>t(i.findIndex(t=>t.id===e)))),focusOrCreateTab(e){chrome.windows.getAll({populate:!0},(function(t){var i=null;for(var a in t){var s=t[a].tabs;for(var r in s){var n=s[r];if(n.url==e){i=n;break}}}i?chrome.tabs.update(i.id,{selected:!0}):chrome.tabs.create({url:e,selected:!0})}))}};function _(e,t,i){chrome.notifications.create("",{iconUrl:"../images/icon128.png",type:"basic",title:e,message:t},e=>{if("function"==typeof i){let t=a=>{e===a&&i(),chrome.notifications.onClicked.removeListener(t)};chrome.notifications.onClicked.addListener(t)}})}const T={info(e,...t){console.log(`===${e}===`,...t)},error(e,...t){console.log(`ERROR: ===${e}===`,...t)}},M={ongoing:!1,tabId:null,status:{},urlListState:{},liveList:[],liveListWithData:[],liveToGet:[],liveListStatus:{hasInit:!1,isIniting:!1},isInitingList:!1,fetching:{total:0,totalCompleted:0,livePercent:0,liveInfo:null},hasLogin:!1,dataToSave:[],isErrorTime(e){const t=(new Date).getTime()-e,i=t/864e5>30;return(!i||!(0>t))&&(i?"isBefore":"isAfter")},setLiveList(e){this.liveList=e||this.liveList,this.liveListWithData=this.liveList.filter(e=>!this.isErrorTime(e.startTime))},isSameLive:(e,t)=>["id","title","accountId","startTime"].every(i=>e[i]===t[i]),async initLiveList(e){T(n);let t=1;const i=this.liveList;let a=!0,s=[];for(;a;)try{const e=await this.getList(t);this.hasLogin=!0,1==t++&&i.length&&this.isSameLive(e[0],i[0])?(s=i,a=!1):(s.push(...e),a=e.length>=20)}catch(t){return T.error(n,t.message),a=!1,"NOT_LOGIN"===t.message&&e&&(this.hasLogin=!1,confirm("您暂未登录淘宝直播后台，请先登录后再获取数据，是否马上去登录？")&&this.createLoginTab()),!1}this.liveListStatus.isIniting=!1,this.liveListStatus.hasInit=!0,this.setLiveList(s),chrome.storage.local.set({liveList:JSON.stringify(this.liveList)},()=>T.info(o,this.liveList))},async getList(e=1){this.liveListStatus.isIniting=!0,1===e&&(this.liveList=[]);return(await y(`https://liveplatform.taobao.com/live/action.do?currentPage=${e}&pagesize=20&api=get_live_list`)).model.data.map(e=>({...e,title:v(e.title)}))},getUrlKey:e=>new URL(decodeURIComponent(e).replace(/\\/g,"")).searchParams.get("data").replace(/[0-9undefined]/g,""),async startFetch(e){const i=this.getUrlKey(e.url),a=t[i];if(a){this.urlListState[e.url]={header:e.requestHeaders,urlKey:i};try{const t=await y(e.url);if(t.ret&&!t.ret.some(e=>e.includes("SUCCESS")))throw Error(t.ret.join("；"));if(0!==t.data.errCode)throw Error(t.data.errMsg);this.dataToSave.push({data:{liveId:this.fetching.liveInfo.id,[a.toSaveDataProp]:JSON.stringify(t.data.data)},api:a.toSaveApi}),this.finishSingleQuery(e)}catch(e){this.interceptWithErr("unable to fetch: "+e.message)}}},isQueryApi:e=>"GET"===e.method&&e.url.includes("mtop.alibaba.iic.xinsightshop.olap.query"),getCubeId(t){const i=e.find(({cubeId:e})=>t.includes(e));return i?i.cubeId:""},finishSingleQuery(e){const{urlKey:i}=this.urlListState[e.url];i&&(this.status[i]=!0,this.updateLiveProgress(),Object.keys(t).every(e=>this.status[e])&&this.finish())},isRequestFromBackground:e=>-1===e.tabId&&!e.frameId,onBeforeSendHeaders(e){if(this.isQueryApi(e)){if(this.isRequestFromBackground(e))try{const t=this.urlListState[e.url].header;t&&(e.requestHeaders=t)}catch(e){T.error(BLOCK_HEADERS,e.message)}else if(e.frameId)return this.startFetch(e),"tblive_rpt_item_indicator"===this.getCubeId(e.url)?{}:{cancel:!0}}else e.url.includes("liveplatform.taobao.com")&&this.isRequestFromBackground(e)&&function(e,t){let i=!1;for(var a=0;e.length>a;a++)if(e[a].name.toLowerCase()==name){i=!0,e.splice(a,1,t);break}i||e.push(t)}(e.requestHeaders,{name:"referer",value:i});return{requestHeaders:e.requestHeaders}},loadIframe(e){chrome.tabs.sendMessage(this.tabId,{type:"FROM_LIVE_ASSISTANT_LOAD_IFRAME",data:"https://databot.taobao.com/tb/tblive?liveId="+e},e=>{})},createLoginTab(){let e=(t,i,a)=>{t===a.id&&/^https:\/\/liveplatform.taobao.com\/live\/liveList.htm/.test(i.url)&&(this.hasLogin=!0,_("通知","成功登陆中控台，回到豹播进行同步吧",async()=>{}),setTimeout(async()=>{this.initLiveList(),chrome.tabs.highlight({tabs:await I.getIndex(this.tabId)})},1e3),chrome.tabs.onUpdated.removeListener(e))};chrome.tabs.create({url:i},()=>{chrome.tabs.onUpdated.addListener(e)})},reConnectTab(e){this.liveToGet.length&&(_("恢复同步","你回到了豹播，将继续上次未完成的同步"),M.startSync(e))},async startSync(e,t){if(T.info(u,{tabId:e,liveId:t,liveToGet:this.liveToGet}),this.ongoing)return _("提示","请等待当前同步完成"),!1;this.tabId=e,(this.liveList.length||(_("通知","首次启动，请等待列表初始化"),await this.initLiveList(!0)))&&(t?this.liveToGet=[t]:this.liveToGet&&this.liveToGet.length||(this.liveToGet=this.liveListWithData.map(e=>e.id),_("通知",this.liveToGet.length?`即将开始同步该账号近30天的直播数据，共${this.liveToGet.length}条`:"该账号下无任何直播场次")),this.updateTotalPorgress(),this.run(this.liveToGet.shift()))},initStatus(){this.ongoing=!1,this.status={},this.urlListState={},this.dataToSave=[]},async run(e){if(this.fetching.liveInfo=this.liveList.find(t=>Number(t.id)===Number(e)),T.info(d,this.fetching.liveInfo),!this.fetching.liveInfo)return this.syncFailed(`该账号下未找 id 为 ${e} 的场次`);if(4===this.fetching.liveInfo.status)return this.syncFailed("该场次还未开始："+this.fetching.liveInfo.title);if(1!==this.fetching.liveInfo.status)return this.syncFailed(`该场次状态不正确，为${this.fetching.liveInfo.status}：${this.fetching.liveInfo.title}`);const t=this.isErrorTime(this.fetching.liveInfo.startTime);return"isBefore"===t?this.syncFailed("仅保留近30日开播场次数据，当前场次数据已清除："+this.fetching.liveInfo.title):"isAfter"===t?this.syncFailed("当前场次还未开播："+this.fetching.liveInfo.title):(_("同步中","当前同步场次： "+this.fetching.liveInfo.title),this.initStatus(),this.ongoing=!0,void this.loadIframe(e))},updateTotalPorgress(e){const t=this.liveToGet.length;this.fetching.total||(this.fetching.total=t),this.fetching.totalCompleted=t,this.fetching.livePercent=0,chrome.browserAction.setBadgeText({text:(t||"")+""}),chrome.runtime.sendMessage({type:"progress",data:this.fetching})},updateLiveProgress(){const t=e.length,i=Object.keys(this.status).length/t;this.fetching.livePercent=i,chrome.runtime.sendMessage({type:"progress",data:this.fetching}),T.info(m,i)},syncFailed(e){_("同步失败",e),this.initStatus(),this.updateTotalPorgress()},async finish(){try{await this.save(),_("同步结束","已同步 "+this.fetching.liveInfo.title),this.liveToGet.length&&setTimeout(()=>{this.run(this.liveToGet.shift())},3e3)}catch(e){this.interceptWithErr("save failed: "+e.message)}this.initStatus(),this.updateTotalPorgress()},pause(e){this.initStatus(),this.fetching.liveInfo&&this.liveToGet.unshift(this.fetching.liveInfo.id),_("同步中断",""+err)},interceptWithErr(e){this.initStatus(),_("同步中断",""+e)},async save(){const e={viewCount:this.fetching.liveInfo.extendsMap.totalPV,liveId:this.fetching.liveInfo.id,expired:!1,descInfo:"",praiseCount:0,joinCount:0,totalJoinCount:0,totalViewCount:0,...(({accountId:e,appointmentTime:t,approval:i,bizCode:a,coverImg:s,coverImg169:r,coverImg916:n,endTime:o,liveChannelId:l,liveColumnId:u,location:d,nativeFeedDetailUrl:m,publishSource:c,startTime:p,title:f,type:v,userNick:h})=>({accountId:e,appointmentTime:t,approval:i,bizCode:a,coverImg:s,coverImg169:r,coverImg916:n,endTime:o,liveChannelId:l,liveColumnId:u,location:d,nativeFeedDetailUrl:m,publishSource:c,startTime:p,title:f,type:v,userNick:h}))(this.fetching.liveInfo)};T(r,this.dataToSave,e);await b("tbMonitorLiveProfile/save",e);for(const e in this.dataToSave){const{api:t,data:i}=this.dataToSave[e],a=await b(t,i);if(0!==a.status)throw Error(a.msg)}}};chrome.browserAction.setBadgeText({text:""}),console.log(M),chrome.webRequest.onBeforeSendHeaders.addListener(M.onBeforeSendHeaders.bind(M),{urls:["*://*.taobao.com/*"]},["blocking","requestHeaders","extraHeaders"]),chrome.storage.local.get(["liveList"],(function(e){T.info(l,e);try{const t=JSON.parse(e.liveList);M.setLiveList(t),M.liveListStatus.hasInit=!!t.length}catch(e){M.liveList=[]}M.initLiveList()})),chrome.runtime.onMessage.addListener((e,t,i)=>{console.log(t.tab?"from a content script:"+t.tab.url:"from the extension",e,t);let a="";"GET_ALL_LIVE"!==e.type&&"GET_SINGLE_LIVE"!==e.type||M.startSync(t.tab.id,e.data),"GET_LIVE_LIST"===e.type&&(a={hasLogin:M.hasLogin,liveListWithData:M.liveListWithData,liveList:M.liveList,hasInit:M.liveListStatus.hasInit,isIniting:M.liveListStatus.isIniting}),i(a)}),chrome.tabs.onRemoved.addListener((e,t)=>{console.log(c,M.tabId,e,t),M.tabId===e&&M.ongoing&&M.pause("你退出了豹播，同步将会在下次进入豹播后继续")}),chrome.tabs.onUpdated.addListener((e,t,i)=>{"complete"===t.status&&function(e=""){try{return[a,s,"127.0.0.1"].includes(new URL(e).hostname)}catch(e){}}(i.url)&&M.reConnectTab(e)})}));
