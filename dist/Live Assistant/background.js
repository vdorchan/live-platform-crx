!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";const e="https://liveplatform.taobao.com/live/liveList.htm",t="https://live.baowenonline.com",i="https://testlive.baowenonline.com",s=[{key:"topNum",cubeId:"tblive_rpt_ind_trend",toSaveDataProp:"liveMaxOnlineDataStr",param:'{"param":"{"queryId":"0|9616773|undefined","cubeId":"tblive_rpt_ind_trend","queryDetail":false,"startTime":"2020-07-26 20:00:01","endTime":"2020-07-26 23:00:46","timeType":2,"sign":null,"limit":1,"row":"[]","measure":"[{"name":"峰值PM在线人数","isMeasure":true}]","column":"[]","orders":"[]","filter":"[{"name":"开播日期分区字段yyyymmdd","type":"dimension","isMeasure":false,"values":["20200726"],"oper":"="},{"name":"直播间id","type":"dimension","isMeasure":false,"values":["272922348257"],"oper":"="},{"name":"主播id","type":"dimension","isMeasure":false,"values":[2081592196],"oper":"="}]","extra":null}","innerId":""}'},{cubeId:"tblive_rpt_abstract_indicator",toSaveDataProp:"accessAndTransformDataStr",param:'{"param":"{"queryId":"1|95654043|undefined","cubeId":"tblive_rpt_abstract_indicator","queryDetail":false,"startTime":"2020-07-26 20:00:01","endTime":"2020-07-26 23:00:46","timeType":2,"sign":null,"limit":1,"row":"[]","measure":"[{"name":"观看次数","isMeasure":true},{"name":"额外奖励流量","isMeasure":true},{"name":"计算平均在线时长","isMeasure":true},{"name":"引导进店次数","isMeasure":true},{"name":"新增粉丝数","isMeasure":true},{"name":"PM观看次数","isMeasure":true},{"name":"PM在线人数","isMeasure":true},{"name":"计算封面图点击率","isMeasure":true},{"name":"直播间浏览次数_粉丝占比","isMeasure":true},{"name":"引导进店次数_粉丝占比","isMeasure":true}]","column":"[]","orders":"[]","filter":"[{"name":"开播日期分区字段yyyymmdd","type":"dimension","isMeasure":false,"values":["20200726"],"oper":"="},{"name":"直播间id","type":"dimension","isMeasure":false,"values":["272922348257"],"oper":"="},{"name":"主播id","type":"dimension","isMeasure":false,"values":[2081592196],"oper":"="}]","extra":null}","innerId":""}'},{cubeId:"dws_mit_cbot_slr_lime_rpt_ov_deal",toSaveDataProp:"liveSummaryOrderDataStr",param:'{"param":"{"queryId":"2|87451842|undefined","cubeId":"dws_mit_cbot_slr_lime_rpt_ov_deal","queryDetail":false,"startTime":"2020-07-26 20:00:01","endTime":"2020-07-26 23:00:46","timeType":2,"sign":null,"limit":1,"row":"[]","measure":"[{"name":"引导成交笔数","isMeasure":true},{"name":"引导成交笔数_粉丝占比","isMeasure":true},{"name":"引导成交金额","isMeasure":true},{"name":"引导成交金额_粉丝占比","isMeasure":true}]","column":"[]","orders":"[]","filter":"[{"name":"开播日期分区字段yyyymmdd","type":"dimension","isMeasure":false,"values":["20200726"],"oper":"="},{"name":"直播间id","type":"dimension","isMeasure":false,"values":["272922348257"],"oper":"="},{"name":"主播id","type":"dimension","isMeasure":false,"values":[2081592196],"oper":"="}]","extra":null}","innerId":""}'},{cubeId:"tblive_rpt_abstract_indicator",toSaveDataProp:"liveAvgOnlineData",param:'{"param":"{"queryId":"3|21472062|undefined","cubeId":"tblive_rpt_abstract_indicator","queryDetail":false,"startTime":"2020-07-26 20:00:01","endTime":"2020-07-26 23:00:46","timeType":2,"sign":null,"limit":1,"row":"[]","measure":"[{"name":"计算平均在线时长","isMeasure":true}]","column":"[]","orders":"[]","filter":"[{"name":"是否粉丝","type":"dimension","isMeasure":false,"values":["Y"],"oper":"="},{"name":"开播日期分区字段yyyymmdd","type":"dimension","isMeasure":false,"values":["20200726"],"oper":"="},{"name":"直播间id","type":"dimension","isMeasure":false,"values":["272922348257"],"oper":"="},{"name":"主播id","type":"dimension","isMeasure":false,"values":[2081592196],"oper":"="}]","extra":null}","innerId":""}'},{cubeId:"tblive_rpt_ind_trend",toSaveDataProp:"liveRealtimeTendDataStr",param:'{"param":"{"queryId":"4|65884581|undefined","cubeId":"tblive_rpt_ind_trend","queryDetail":false,"startTime":"2020-07-26 20:00:01","endTime":"2020-07-26 23:00:46","timeType":2,"sign":null,"limit":2000,"row":"[{"name":"时间精确到分钟","isMeasure":false}]","measure":"[{"name":"PM观看次数","isMeasure":true}]","column":"[]","orders":"[]","filter":"[{"name":"开播日期分区字段yyyymmdd","type":"dimension","isMeasure":false,"values":["20200726"],"oper":"="},{"name":"直播间id","type":"dimension","isMeasure":false,"values":["272922348257"],"oper":"="},{"name":"主播id","type":"dimension","isMeasure":false,"values":[2081592196],"oper":"="}]","extra":null}","innerId":""}'},{cubeId:"tblive_rpt_ind_trend",toSaveDataProp:"liveRealtimeTendDataStr",param:'{"param":"{"queryId":"5|30278359|undefined","cubeId":"tblive_rpt_ind_trend","queryDetail":false,"startTime":"2020-07-26 20:00:01","endTime":"2020-07-26 23:00:46","timeType":2,"sign":null,"limit":2000,"row":"[{"name":"时间精确到分钟","isMeasure":false}]","measure":"[{"name":"观看次数","isMeasure":true}]","column":"[]","orders":"[]","filter":"[{"name":"开播日期分区字段yyyymmdd","type":"dimension","isMeasure":false,"values":["20200726"],"oper":"="},{"name":"直播间id","type":"dimension","isMeasure":false,"values":["272922348257"],"oper":"="},{"name":"主播id","type":"dimension","isMeasure":false,"values":[2081592196],"oper":"="}]","extra":null}","innerId":""}'},{cubeId:"tblive_rpt_ind_trend",toSaveDataProp:"liveRealtimeTendDataStr",param:'{"param":"{"queryId":"6|93131114|undefined","cubeId":"tblive_rpt_ind_trend","queryDetail":false,"startTime":"2020-07-26 20:00:01","endTime":"2020-07-26 23:00:46","timeType":2,"sign":null,"limit":2000,"row":"[{"name":"时间精确到分钟","isMeasure":false}]","measure":"[{"name":"PM在线人数","isMeasure":true}]","column":"[]","orders":"[]","filter":"[{"name":"开播日期分区字段yyyymmdd","type":"dimension","isMeasure":false,"values":["20200726"],"oper":"="},{"name":"直播间id","type":"dimension","isMeasure":false,"values":["272922348257"],"oper":"="},{"name":"主播id","type":"dimension","isMeasure":false,"values":[2081592196],"oper":"="}]","extra":null}","innerId":""}'},{cubeId:"mit_cbot_slr_lime_rpt_ov_trend_deal",toSaveDataProp:"liveRealtimeTendDataStr",param:'{"param":"{"queryId":"7|5760439|undefined","cubeId":"mit_cbot_slr_lime_rpt_ov_trend_deal","queryDetail":false,"startTime":"2020-07-26 20:00:01","endTime":"2020-07-26 23:00:46","timeType":2,"sign":null,"limit":2000,"row":"[{"name":"时间精确到分钟","isMeasure":false}]","measure":"[{"name":"引导成交金额","isMeasure":true}]","column":"[]","orders":"[]","filter":"[{"name":"开播日期分区字段yyyymmdd","type":"dimension","isMeasure":false,"values":["20200726"],"oper":"="},{"name":"直播间id","type":"dimension","isMeasure":false,"values":["272922348257"],"oper":"="},{"name":"主播id","type":"dimension","isMeasure":false,"values":[2081592196],"oper":"="}]","extra":null}","innerId":""}'},{cubeId:"tblive_rpt_ind_trend",toSaveDataProp:"liveRealtimeTendDataStr",param:'{"param":"{"queryId":"8|5024396|undefined","cubeId":"tblive_rpt_ind_trend","queryDetail":false,"startTime":"2020-07-26 20:00:01","endTime":"2020-07-26 23:00:46","timeType":2,"sign":null,"limit":2000,"row":"[{"name":"时间精确到分钟","isMeasure":false}]","measure":"[{"name":"引导进店次数","isMeasure":true}]","column":"[]","orders":"[]","filter":"[{"name":"开播日期分区字段yyyymmdd","type":"dimension","isMeasure":false,"values":["20200726"],"oper":"="},{"name":"直播间id","type":"dimension","isMeasure":false,"values":["272922348257"],"oper":"="},{"name":"主播id","type":"dimension","isMeasure":false,"values":[2081592196],"oper":"="}]","extra":null}","innerId":""}'},{cubeId:"tblive_rpt_ind_trend",toSaveDataProp:"liveRealtimeTendDataStr",param:'{"param":"{"queryId":"9|64096482|undefined","cubeId":"tblive_rpt_ind_trend","queryDetail":false,"startTime":"2020-07-26 20:00:01","endTime":"2020-07-26 23:00:46","timeType":2,"sign":null,"limit":2000,"row":"[{"name":"时间精确到分钟","isMeasure":false}]","measure":"[{"name":"新增粉丝数","isMeasure":true}]","column":"[]","orders":"[]","filter":"[{"name":"开播日期分区字段yyyymmdd","type":"dimension","isMeasure":false,"values":["20200726"],"oper":"="},{"name":"直播间id","type":"dimension","isMeasure":false,"values":["272922348257"],"oper":"="},{"name":"主播id","type":"dimension","isMeasure":false,"values":[2081592196],"oper":"="}]","extra":null}","innerId":""}'},{cubeId:"tblive_rpt_source_trend",toSaveDataProp:"liveSourceChannelDataStr",param:'{"param":"{"queryId":"10|51041760|undefined","cubeId":"tblive_rpt_source_trend","queryDetail":false,"startTime":"2020-07-26 20:00:01","endTime":"2020-07-26 23:00:46","timeType":2,"sign":null,"limit":2000,"row":"[{"name":"时间精确到分钟","isMeasure":false},{"name":"直播间来源","isMeasure":false}]","measure":"[{"name":"观看次数","isMeasure":true}]","column":"[]","orders":"[]","filter":"[{"name":"开播日期分区字段yyyymmdd","type":"dimension","isMeasure":false,"values":["20200726"],"oper":"="},{"name":"直播间id","type":"dimension","isMeasure":false,"values":["272922348257"],"oper":"="},{"name":"主播id","type":"dimension","isMeasure":false,"values":[2081592196],"oper":"="}]","extra":null}","innerId":""}'},{cubeId:"tblive_rpt_item_indicator",toSaveDataProp:"productViewDataStr",param:'{"param":"{"queryId":"11|33606177|undefined","cubeId":"tblive_rpt_item_indicator","queryDetail":false,"startTime":"2020-07-26 20:00:01","endTime":"2020-07-26 23:00:46","timeType":2,"sign":null,"limit":2000,"row":"[{"name":"商品id","isMeasure":false},{"name":"主图地址","isMeasure":false},{"name":"商品标题","isMeasure":false}]","measure":"[{"name":"商品点击次数","isMeasure":true},{"name":"商品点击人数","isMeasure":true}]","column":"[]","orders":"[]","filter":"[{"name":"开播日期分区字段yyyymmdd","type":"dimension","isMeasure":false,"values":["20200726"],"oper":"="},{"name":"直播间id","type":"dimension","isMeasure":false,"values":["272922348257"],"oper":"="},{"name":"主播id","type":"dimension","isMeasure":false,"values":[2081592196],"oper":"="}]","extra":null}","innerId":""}'},{cubeId:"dws_mit_cbot_slr_lime_rpt_itm_deal",toSaveDataProp:"productOrderDataStr",param:'{"param":"{"queryId":"12|83415245|undefined","cubeId":"dws_mit_cbot_slr_lime_rpt_itm_deal","queryDetail":false,"startTime":"2020-07-26 20:00:01","endTime":"2020-07-26 23:00:46","timeType":2,"sign":null,"limit":2000,"row":"[{"name":"商品id","isMeasure":false}]","measure":"[{"name":"引导成交件数","isMeasure":true},{"name":"引导成交金额","isMeasure":true}]","column":"[]","orders":"[]","filter":"[{"name":"开播日期分区字段yyyymmdd","type":"dimension","isMeasure":false,"values":["20200726"],"oper":"="},{"name":"直播间id","type":"dimension","isMeasure":false,"values":["272922348257"],"oper":"="},{"name":"主播id","type":"dimension","isMeasure":false,"values":[2081592196],"oper":"="}]","extra":null}","innerId":""}'}],a={};function r(e){const t={"&amp;":"&","&apos;":"'","&gt;":">","&lt;":"<","&quot;":'"'},i=RegExp("("+Object.keys(t).join("|")+")","g");return e.replace(i,(function(e){return t[e]}))}s.forEach(e=>{a[e.param.replace(/[0-9undefined]/g,"")]={cubeId:e.cubeId,toSaveDataProp:e.toSaveDataProp}});const n={getIndex:e=>new Promise(t=>chrome.tabs.query({},i=>t(i.findIndex(t=>t.id===e)))),focusOrCreateTab(e){chrome.windows.getAll({populate:!0},(function(t){var i=null;for(var s in t){var a=t[s].tabs;for(var r in a){var n=a[r];if(n.url==e){i=n;break}}}i?chrome.tabs.update(i.id,{selected:!0}):chrome.tabs.create({url:e,selected:!0})}))}};function l(e,t,i){chrome.notifications.create("",{iconUrl:"../images/icon128.png",type:"basic",title:e,message:t},e=>{if("function"==typeof i){let t=s=>{e===s&&i(),chrome.notifications.onClicked.removeListener(t)};chrome.notifications.onClicked.addListener(t)}})}const o={ongoing:!1,tabId:null,status:{},urlListState:{},liveList:[],liveListWithData:[],liveToGet:[],liveListStatus:{hasInit:!1,isIniting:!1},isInitingList:!1,fetching:{total:0,totalCompleted:0,livePercent:0,liveInfo:null},hasLogin:!1,isErrorTime(e){const t=(new Date).getTime()-e,i=t>0;return(!i||!(30>t/864e5))&&(i?"isBefore":"isAfter")},setLiveList(e){this.liveList=e||this.liveList,this.liveListWithData=this.liveList.filter(e=>!this.isErrorTime(e.startTime))},isSameLive:(e,t)=>["id","title","accountId","startTime"].every(i=>e[i]===t[i]),async initLiveList(e){console.log("initLiveList");let t=1;const i=this.liveList;let s=!0,a=[];for(;s;)try{const e=await this.getList(t);this.hasLogin=!0,1==t++&&i.length&&this.isSameLive(e[0],i[0])?(a=i,s=!1):(a.push(...e),s=e.length>=20)}catch(t){throw console.log(t),s=!1,"NOT_LOGIN"===t.message&&e&&(this.hasLogin=!1,confirm("您暂未登录淘宝直播后台，请先登录后再获取数据，是否马上去登录？")&&this.createLoginTab()),Error()}this.liveListStatus.isIniting=!1,this.liveListStatus.hasInit=!0,this.setLiveList(a),chrome.storage.local.set({liveList:JSON.stringify(this.liveList)},()=>console.log("store live list",this.liveList))},async getList(e=1){this.liveListStatus.isIniting=!0,1===e&&(this.liveList=[]);return(await async function(e){const t=await fetch(e,{referrerPolicy:"no-referrer-when-downgrade",body:null,method:"GET",mode:"cors",credentials:"include"});if(/^https:\/\/login.taobao.com\/member\/login\.jhtml/.test(t.url))throw Error("NOT_LOGIN");if(200===t.status)return t.json();throw Error(t)}(`https://liveplatform.taobao.com/live/action.do?currentPage=${e}&pagesize=20&api=get_live_list`)).model.data.map(e=>({...e,title:r(e.title)}))},getUrlKey:e=>new URL(decodeURIComponent(e).replace(/\\/g,"")).searchParams.get("data").replace(/[0-9undefined]/g,""),async startFetch(e){const t=this.getUrlKey(e.url);if(a[t]){this.urlListState[e.url]={header:e.requestHeaders,urlKey:t};try{this.finishSingleQuery(e)}catch(e){this.interceptWithErr(e.message)}}},isQueryApi:e=>"GET"===e.method&&e.url.includes("mtop.alibaba.iic.xinsightshop.olap.query"),getCubeId(e){const t=s.find(({cubeId:t})=>e.includes(t));return t?t.cubeId:""},finishSingleQuery(e){const{urlKey:t}=this.urlListState[e.url];t&&(this.status[t]=!0,this.updateLiveProgress(),Object.keys(a).every(e=>this.status[e])&&this.finish())},isRequestFromBackground:e=>-1===e.tabId&&!e.frameId,onBeforeSendHeaders(t){if(this.isQueryApi(t)){if(this.isRequestFromBackground(t))try{const e=this.urlListState[t.url].header;e&&(t.requestHeaders=e)}catch(e){console.log("error header")}else if(t.frameId)return this.startFetch(t),"tblive_rpt_item_indicator"===this.getCubeId(t.url)?{}:{cancel:!0}}else t.url.includes("liveplatform.taobao.com")&&this.isRequestFromBackground(t)&&function(e,t){let i=!1;for(var s=0;e.length>s;s++)if(e[s].name.toLowerCase()==name){i=!0,e.splice(s,1,t);break}i||e.push(t)}(t.requestHeaders,{name:"referer",value:e});return{requestHeaders:t.requestHeaders}},loadIframe(e){chrome.tabs.sendMessage(this.tabId,{type:"FROM_LIVE_ASSISTANT_LOAD_IFRAME",data:"https://databot.taobao.com/tb/tblive?liveId="+e},e=>{console.log(e)})},createLoginTab(){let t=(e,i,s)=>{e===s.id&&/^https:\/\/liveplatform.taobao.com\/live\/liveList.htm/.test(i.url)&&(this.hasLogin=!0,l("通知","成功登陆中控台，回到豹播进行同步吧",async()=>{}),setTimeout(async()=>{this.initLiveList(),chrome.tabs.highlight({tabs:await n.getIndex(this.tabId)})},1e3),chrome.tabs.onUpdated.removeListener(t))};chrome.tabs.create({url:e},()=>{chrome.tabs.onUpdated.addListener(t)})},reConnectTab(e){this.liveToGet.length&&(l("恢复同步","你回到了豹播，将继续上次未完成的同步"),o.startSync(e))},async startSync(e,t){if(console.log("startSync",e,t,this.liveToGet),this.ongoing)return l("提示","请等待当前同步完成"),!1;this.tabId=e,this.liveList.length||(l("通知","首次启动，请等待列表初始化"),await this.initLiveList(!0)),t?this.liveToGet=[t]:this.liveToGet&&this.liveToGet.length||(this.liveToGet=this.liveListWithData.map(e=>e.id),l("通知",this.liveToGet.length?`即将开始同步该账号近30天的直播数据，共${this.liveToGet.length}条`:"该账号下无任何直播场次")),this.updateTotalPorgress(),this.run(this.liveToGet.shift())},initStatus(){this.ongoing=!1,this.status={},this.urlListState={}},async run(e){if(this.fetching.liveInfo=this.liveList.find(t=>Number(t.id)===Number(e)),console.log("run",this.fetching.liveInfo),!this.fetching.liveInfo)return l("同步失败",`该账号下未找 id 为 ${e} 的场次`);if(4===this.fetching.liveInfo.status)return l("同步失败","该场次还未开始："+this.fetching.liveInfo.title);if(1!==this.fetching.liveInfo.status)return l("同步失败",`该场次状态不正确，为${this.fetching.liveInfo.status}：${this.fetching.liveInfo.title}`);const t=this.isErrorTime(this.fetching.liveInfo.startTime);return"isAfter"===t?l("同步失败","仅保留近30日开播场次数据，当前场次数据已清除："+this.fetching.liveInfo.title):"isBefore"===t?l("同步失败","当前场次还未开播："+this.fetching.liveInfo.title):(l("同步中","当前同步场次： "+this.fetching.liveInfo.title),this.initStatus(),this.ongoing=!0,void this.loadIframe(e))},updateTotalPorgress(e){const t=this.liveToGet.length;this.fetching.total||(this.fetching.total=t),this.fetching.totalCompleted=t,this.fetching.livePercent=0,chrome.browserAction.setBadgeText({text:(t||"")+""}),chrome.runtime.sendMessage({type:"progress",data:this.fetching})},updateLiveProgress(){const e=s.length,t=Object.keys(this.status).length/e;this.fetching.livePercent=t,chrome.runtime.sendMessage({type:"progress",data:this.fetching}),console.log("updateLiveProgress",t)},async finish(){var e;l("同步结束","已同步 "+this.fetching.liveInfo.title),this.initStatus(),this.updateTotalPorgress(),this.liveToGet.length&&(await(e=3e3,new Promise(t=>setTimeout(t,e))),this.run(this.liveToGet.shift()))},interceptWithErr(e){this.initStatus(),this.fetching.liveInfo&&this.liveToGet.unshift(this.fetching.liveInfo.id),l("同步中断",""+e)}};chrome.browserAction.setBadgeText({text:""}),console.log(o),chrome.webRequest.onBeforeSendHeaders.addListener(o.onBeforeSendHeaders.bind(o),{urls:["https://*/*","http://*/*"]},["blocking","requestHeaders","extraHeaders"]),chrome.storage.local.get(["liveList"],(function(e){console.log("get live list from store",e);try{const t=JSON.parse(e.liveList);o.setLiveList(t),o.liveListStatus.hasInit=!!t.length}catch(e){o.liveList=[]}o.initLiveList()})),chrome.runtime.onMessage.addListener((e,t,i)=>{console.log(t.tab?"from a content script:"+t.tab.url:"from the extension",e,t);let s="";"GET_ALL_LIVE"!==e.type&&"GET_SINGLE_LIVE"!==e.type||o.startSync(t.tab.id,e.data),"GET_LIVE_LIST"===e.type&&(s={hasLogin:o.hasLogin,liveListWithData:o.liveListWithData,liveList:o.liveList,hasInit:o.liveListStatus.hasInit,isIniting:o.liveListStatus.isIniting}),i(s)}),chrome.tabs.onRemoved.addListener((e,t)=>{console.log(o.tabId,e,t),o.tabId===e&&o.ongoing&&o.interceptWithErr("你退出了豹播，同步中断")}),chrome.tabs.onUpdated.addListener((e,s,a)=>{"complete"===s.status&&function(e=""){try{return[t,i,"127.0.0.1"].includes(new URL(e).hostname)}catch(e){}}(a.url)&&o.reConnectTab(e)})}));
