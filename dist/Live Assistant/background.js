!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";const e="https://liveplatform.taobao.com/live/liveList.htm",i=[{key:"topNum",cubeId:"tblive_rpt_ind_trend",toSaveDataProp:"liveMaxOnlineDataStr",param:'{"param":"{"queryId":"0|9616773|undefined","cubeId":"tblive_rpt_ind_trend","queryDetail":false,"startTime":"2020-07-26 20:00:01","endTime":"2020-07-26 23:00:46","timeType":2,"sign":null,"limit":1,"row":"[]","measure":"[{"name":"峰值PM在线人数","isMeasure":true}]","column":"[]","orders":"[]","filter":"[{"name":"开播日期分区字段yyyymmdd","type":"dimension","isMeasure":false,"values":["20200726"],"oper":"="},{"name":"直播间id","type":"dimension","isMeasure":false,"values":["272922348257"],"oper":"="},{"name":"主播id","type":"dimension","isMeasure":false,"values":[2081592196],"oper":"="}]","extra":null}","innerId":""}'},{cubeId:"tblive_rpt_abstract_indicator",toSaveDataProp:"accessAndTransformDataStr",param:'{"param":"{"queryId":"1|95654043|undefined","cubeId":"tblive_rpt_abstract_indicator","queryDetail":false,"startTime":"2020-07-26 20:00:01","endTime":"2020-07-26 23:00:46","timeType":2,"sign":null,"limit":1,"row":"[]","measure":"[{"name":"观看次数","isMeasure":true},{"name":"额外奖励流量","isMeasure":true},{"name":"计算平均在线时长","isMeasure":true},{"name":"引导进店次数","isMeasure":true},{"name":"新增粉丝数","isMeasure":true},{"name":"PM观看次数","isMeasure":true},{"name":"PM在线人数","isMeasure":true},{"name":"计算封面图点击率","isMeasure":true},{"name":"直播间浏览次数_粉丝占比","isMeasure":true},{"name":"引导进店次数_粉丝占比","isMeasure":true}]","column":"[]","orders":"[]","filter":"[{"name":"开播日期分区字段yyyymmdd","type":"dimension","isMeasure":false,"values":["20200726"],"oper":"="},{"name":"直播间id","type":"dimension","isMeasure":false,"values":["272922348257"],"oper":"="},{"name":"主播id","type":"dimension","isMeasure":false,"values":[2081592196],"oper":"="}]","extra":null}","innerId":""}'},{cubeId:"dws_mit_cbot_slr_lime_rpt_ov_deal",toSaveDataProp:"liveSummaryOrderDataStr",param:'{"param":"{"queryId":"2|87451842|undefined","cubeId":"dws_mit_cbot_slr_lime_rpt_ov_deal","queryDetail":false,"startTime":"2020-07-26 20:00:01","endTime":"2020-07-26 23:00:46","timeType":2,"sign":null,"limit":1,"row":"[]","measure":"[{"name":"引导成交笔数","isMeasure":true},{"name":"引导成交笔数_粉丝占比","isMeasure":true},{"name":"引导成交金额","isMeasure":true},{"name":"引导成交金额_粉丝占比","isMeasure":true}]","column":"[]","orders":"[]","filter":"[{"name":"开播日期分区字段yyyymmdd","type":"dimension","isMeasure":false,"values":["20200726"],"oper":"="},{"name":"直播间id","type":"dimension","isMeasure":false,"values":["272922348257"],"oper":"="},{"name":"主播id","type":"dimension","isMeasure":false,"values":[2081592196],"oper":"="}]","extra":null}","innerId":""}'},{cubeId:"tblive_rpt_abstract_indicator",toSaveDataProp:"liveAvgOnlineData",param:'{"param":"{"queryId":"3|21472062|undefined","cubeId":"tblive_rpt_abstract_indicator","queryDetail":false,"startTime":"2020-07-26 20:00:01","endTime":"2020-07-26 23:00:46","timeType":2,"sign":null,"limit":1,"row":"[]","measure":"[{"name":"计算平均在线时长","isMeasure":true}]","column":"[]","orders":"[]","filter":"[{"name":"是否粉丝","type":"dimension","isMeasure":false,"values":["Y"],"oper":"="},{"name":"开播日期分区字段yyyymmdd","type":"dimension","isMeasure":false,"values":["20200726"],"oper":"="},{"name":"直播间id","type":"dimension","isMeasure":false,"values":["272922348257"],"oper":"="},{"name":"主播id","type":"dimension","isMeasure":false,"values":[2081592196],"oper":"="}]","extra":null}","innerId":""}'},{cubeId:"tblive_rpt_ind_trend",toSaveDataProp:"liveRealtimeTendDataStr",param:'{"param":"{"queryId":"4|65884581|undefined","cubeId":"tblive_rpt_ind_trend","queryDetail":false,"startTime":"2020-07-26 20:00:01","endTime":"2020-07-26 23:00:46","timeType":2,"sign":null,"limit":2000,"row":"[{"name":"时间精确到分钟","isMeasure":false}]","measure":"[{"name":"PM观看次数","isMeasure":true}]","column":"[]","orders":"[]","filter":"[{"name":"开播日期分区字段yyyymmdd","type":"dimension","isMeasure":false,"values":["20200726"],"oper":"="},{"name":"直播间id","type":"dimension","isMeasure":false,"values":["272922348257"],"oper":"="},{"name":"主播id","type":"dimension","isMeasure":false,"values":[2081592196],"oper":"="}]","extra":null}","innerId":""}'},{cubeId:"tblive_rpt_ind_trend",toSaveDataProp:"liveRealtimeTendDataStr",param:'{"param":"{"queryId":"5|30278359|undefined","cubeId":"tblive_rpt_ind_trend","queryDetail":false,"startTime":"2020-07-26 20:00:01","endTime":"2020-07-26 23:00:46","timeType":2,"sign":null,"limit":2000,"row":"[{"name":"时间精确到分钟","isMeasure":false}]","measure":"[{"name":"观看次数","isMeasure":true}]","column":"[]","orders":"[]","filter":"[{"name":"开播日期分区字段yyyymmdd","type":"dimension","isMeasure":false,"values":["20200726"],"oper":"="},{"name":"直播间id","type":"dimension","isMeasure":false,"values":["272922348257"],"oper":"="},{"name":"主播id","type":"dimension","isMeasure":false,"values":[2081592196],"oper":"="}]","extra":null}","innerId":""}'},{cubeId:"tblive_rpt_ind_trend",toSaveDataProp:"liveRealtimeTendDataStr",param:'{"param":"{"queryId":"6|93131114|undefined","cubeId":"tblive_rpt_ind_trend","queryDetail":false,"startTime":"2020-07-26 20:00:01","endTime":"2020-07-26 23:00:46","timeType":2,"sign":null,"limit":2000,"row":"[{"name":"时间精确到分钟","isMeasure":false}]","measure":"[{"name":"PM在线人数","isMeasure":true}]","column":"[]","orders":"[]","filter":"[{"name":"开播日期分区字段yyyymmdd","type":"dimension","isMeasure":false,"values":["20200726"],"oper":"="},{"name":"直播间id","type":"dimension","isMeasure":false,"values":["272922348257"],"oper":"="},{"name":"主播id","type":"dimension","isMeasure":false,"values":[2081592196],"oper":"="}]","extra":null}","innerId":""}'},{cubeId:"mit_cbot_slr_lime_rpt_ov_trend_deal",toSaveDataProp:"liveRealtimeTendDataStr",param:'{"param":"{"queryId":"7|5760439|undefined","cubeId":"mit_cbot_slr_lime_rpt_ov_trend_deal","queryDetail":false,"startTime":"2020-07-26 20:00:01","endTime":"2020-07-26 23:00:46","timeType":2,"sign":null,"limit":2000,"row":"[{"name":"时间精确到分钟","isMeasure":false}]","measure":"[{"name":"引导成交金额","isMeasure":true}]","column":"[]","orders":"[]","filter":"[{"name":"开播日期分区字段yyyymmdd","type":"dimension","isMeasure":false,"values":["20200726"],"oper":"="},{"name":"直播间id","type":"dimension","isMeasure":false,"values":["272922348257"],"oper":"="},{"name":"主播id","type":"dimension","isMeasure":false,"values":[2081592196],"oper":"="}]","extra":null}","innerId":""}'},{cubeId:"tblive_rpt_ind_trend",toSaveDataProp:"liveRealtimeTendDataStr",param:'{"param":"{"queryId":"8|5024396|undefined","cubeId":"tblive_rpt_ind_trend","queryDetail":false,"startTime":"2020-07-26 20:00:01","endTime":"2020-07-26 23:00:46","timeType":2,"sign":null,"limit":2000,"row":"[{"name":"时间精确到分钟","isMeasure":false}]","measure":"[{"name":"引导进店次数","isMeasure":true}]","column":"[]","orders":"[]","filter":"[{"name":"开播日期分区字段yyyymmdd","type":"dimension","isMeasure":false,"values":["20200726"],"oper":"="},{"name":"直播间id","type":"dimension","isMeasure":false,"values":["272922348257"],"oper":"="},{"name":"主播id","type":"dimension","isMeasure":false,"values":[2081592196],"oper":"="}]","extra":null}","innerId":""}'},{cubeId:"tblive_rpt_ind_trend",toSaveDataProp:"liveRealtimeTendDataStr",param:'{"param":"{"queryId":"9|64096482|undefined","cubeId":"tblive_rpt_ind_trend","queryDetail":false,"startTime":"2020-07-26 20:00:01","endTime":"2020-07-26 23:00:46","timeType":2,"sign":null,"limit":2000,"row":"[{"name":"时间精确到分钟","isMeasure":false}]","measure":"[{"name":"新增粉丝数","isMeasure":true}]","column":"[]","orders":"[]","filter":"[{"name":"开播日期分区字段yyyymmdd","type":"dimension","isMeasure":false,"values":["20200726"],"oper":"="},{"name":"直播间id","type":"dimension","isMeasure":false,"values":["272922348257"],"oper":"="},{"name":"主播id","type":"dimension","isMeasure":false,"values":[2081592196],"oper":"="}]","extra":null}","innerId":""}'},{cubeId:"tblive_rpt_source_trend",toSaveDataProp:"liveSourceChannelDataStr",param:'{"param":"{"queryId":"10|51041760|undefined","cubeId":"tblive_rpt_source_trend","queryDetail":false,"startTime":"2020-07-26 20:00:01","endTime":"2020-07-26 23:00:46","timeType":2,"sign":null,"limit":2000,"row":"[{"name":"时间精确到分钟","isMeasure":false},{"name":"直播间来源","isMeasure":false}]","measure":"[{"name":"观看次数","isMeasure":true}]","column":"[]","orders":"[]","filter":"[{"name":"开播日期分区字段yyyymmdd","type":"dimension","isMeasure":false,"values":["20200726"],"oper":"="},{"name":"直播间id","type":"dimension","isMeasure":false,"values":["272922348257"],"oper":"="},{"name":"主播id","type":"dimension","isMeasure":false,"values":[2081592196],"oper":"="}]","extra":null}","innerId":""}'},{cubeId:"tblive_rpt_item_indicator",toSaveDataProp:"productViewDataStr",param:'{"param":"{"queryId":"11|33606177|undefined","cubeId":"tblive_rpt_item_indicator","queryDetail":false,"startTime":"2020-07-26 20:00:01","endTime":"2020-07-26 23:00:46","timeType":2,"sign":null,"limit":2000,"row":"[{"name":"商品id","isMeasure":false},{"name":"主图地址","isMeasure":false},{"name":"商品标题","isMeasure":false}]","measure":"[{"name":"商品点击次数","isMeasure":true},{"name":"商品点击人数","isMeasure":true}]","column":"[]","orders":"[]","filter":"[{"name":"开播日期分区字段yyyymmdd","type":"dimension","isMeasure":false,"values":["20200726"],"oper":"="},{"name":"直播间id","type":"dimension","isMeasure":false,"values":["272922348257"],"oper":"="},{"name":"主播id","type":"dimension","isMeasure":false,"values":[2081592196],"oper":"="}]","extra":null}","innerId":""}'},{cubeId:"dws_mit_cbot_slr_lime_rpt_itm_deal",toSaveDataProp:"productOrderDataStr",param:'{"param":"{"queryId":"12|83415245|undefined","cubeId":"dws_mit_cbot_slr_lime_rpt_itm_deal","queryDetail":false,"startTime":"2020-07-26 20:00:01","endTime":"2020-07-26 23:00:46","timeType":2,"sign":null,"limit":2000,"row":"[{"name":"商品id","isMeasure":false}]","measure":"[{"name":"引导成交件数","isMeasure":true},{"name":"引导成交金额","isMeasure":true}]","column":"[]","orders":"[]","filter":"[{"name":"开播日期分区字段yyyymmdd","type":"dimension","isMeasure":false,"values":["20200726"],"oper":"="},{"name":"直播间id","type":"dimension","isMeasure":false,"values":["272922348257"],"oper":"="},{"name":"主播id","type":"dimension","isMeasure":false,"values":[2081592196],"oper":"="}]","extra":null}","innerId":""}'}],t={};function a(e){const i={"&amp;":"&","&apos;":"'","&gt;":">","&lt;":"<","&quot;":'"'},t=RegExp("("+Object.keys(i).join("|")+")","g");return e.replace(t,(function(e){return i[e]}))}async function s(e){const i=await fetch(e,{referrerPolicy:"no-referrer-when-downgrade",body:null,method:"GET",mode:"cors",credentials:"include"});if(/^https:\/\/login.taobao.com\/member\/login\.jhtml/.test(i.url))throw Error("NOT_LOGIN");if(200===i.status)return i.json();throw Error(i)}i.forEach(e=>{t[e.param.replace(/[0-9undefined]/g,"")]={cubeId:e.cubeId,toSaveDataProp:e.toSaveDataProp}});const r={getIndex:e=>new Promise(i=>chrome.tabs.query({},t=>i(t.findIndex(i=>i.id===e))))},n={ongoing:!1,fetchingLiveInfo:null,completed:!1,tabId:null,status:{},urlListState:{},liveList:[],liveToGet:[],isOverTime:e=>((new Date).getTime()-e)/864e5>=30,async getList(e=1){1===e&&(this.liveList=[]);const i=(await s(`https://liveplatform.taobao.com/live/action.do?currentPage=${e}&pagesize=20&api=get_live_list`)).model.data.map(e=>({...e,title:a(e.title)}));this.liveList.push(...i),20>i.length?chrome.storage.local.set({liveList:JSON.stringify(this.liveList)},()=>console.log("store live list",this.liveList)):await this.getList(++e)},getUrlKey:e=>new URL(decodeURIComponent(e).replace(/\\/g,"")).searchParams.get("data").replace(/[0-9undefined]/g,""),async startFetch(e){const i=this.getUrlKey(e.url);if(t[i]){this.urlListState[e.url]={header:e.requestHeaders,urlKey:i};try{const i=await s(e.url);if(i.ret&&!i.ret.some(e=>e.includes("SUCCESS")))throw Error(i.ret.join("；"));if(0!==i.data.errCode)throw Error(i.data.errMsg);this.fnishSingleQuery(e)}catch(e){this.interceptWithErr(e.message)}}},isQueryApi:e=>"GET"===e.method&&e.url.includes("mtop.alibaba.iic.xinsightshop.olap.query"),getCubeId(e){const t=i.find(({cubeId:i})=>e.includes(i));return t?t.cubeId:""},fnishSingleQuery(e){const{urlKey:i}=this.urlListState[e.url];i&&(this.status[i]=!0,Object.keys(t).every(e=>this.status[e])&&this.finish())},isRequestFromBackground:e=>-1===e.tabId&&!e.frameId,onBeforeSendHeaders(i){if(this.isQueryApi(i)){if(this.isRequestFromBackground(i))try{const e=this.urlListState[i.url].header;e&&(i.requestHeaders=e)}catch(e){console.log("error header")}else if(i.frameId)return this.startFetch(i),"tblive_rpt_item_indicator"===this.getCubeId(i.url)?{}:{cancel:!0}}else i.url.includes("liveplatform.taobao.com")&&this.isRequestFromBackground(i)&&function(e,i){let t=!1;for(var a=0;e.length>a;a++)if(e[a].name.toLowerCase()==name){t=!0,e.splice(a,1,i);break}t||e.push(i)}(i.requestHeaders,{name:"referer",value:e});return{requestHeaders:i.requestHeaders}},loadIframe(e){chrome.tabs.sendMessage(this.tabId,{type:"FROM_LIVEPLATFORM_ASSISTANT_LOAD_IFRAME",data:"https://databot.taobao.com/tb/tblive?spm=a1z9u.8142865.0.0.7e7434edpErHmP&liveId="+e},e=>{console.log(e)})},notification(e,i,t){chrome.notifications.create("",{iconUrl:"../images/icon128.png",type:"basic",title:e,message:i},e=>{if("function"==typeof t){let i=a=>{e===a&&t(),chrome.notifications.onClicked.removeListener(i)};chrome.notifications.onClicked.addListener(i)}})},getAllLive(e){this.liveToGet=this.liveList.filter(e=>1===e.status||this.isOverTime(e.startTime)).map(e=>e.id),this.run(this.liveToGet.shift())},createLoginTab(){let i=(e,t,a)=>{e===a.id&&/^https:\/\/liveplatform.taobao.com\/live\/liveList.htm/.test(t.url)&&(this.notification("通知","成功登陆中控台，回到豹播进行同步吧",async()=>{chrome.tabs.highlight({tabs:await r.getIndex(this.tabId)})}),chrome.tabs.onUpdated.removeListener(i))};chrome.tabs.create({url:e},()=>{chrome.tabs.onUpdated.addListener(i)})},async startSync(e,i){if(this.ongoing)return this.notification("提示","请等待当前同步完成"),!1;if(this.tabId=e,!this.liveList.length){this.notification("通知","首次启动，请等待列表初始化");try{await this.getList()}catch(e){return console.log(e),void("NOT_LOGIN"===e.message&&confirm("未登录中控台，是否马上去登录？")&&this.createLoginTab())}}i?this.liveToGet=[i]:(this.liveToGet=this.liveList.filter(e=>1===e.status&&!this.isOverTime(e.startTime)).map(e=>e.id),this.notification("通知",`即将开始同步该账号近30天的直播数据，共${this.liveToGet.length}条`)),chrome.browserAction.setBadgeText({text:(this.liveToGet?this.liveToGet.length:1)+""}),this.run(this.liveToGet.shift())},initStatus(){this.ongoing=!1,this.status={},this.urlListState={}},async run(e){return this.fetchingLiveInfo=this.liveList.find(i=>Number(i.id)===Number(e)),console.log("run",this.fetchingLiveInfo),this.fetchingLiveInfo?4===this.fetchingLiveInfo.status?this.notification("同步失败","该场次还未开始："+this.fetchingLiveInfo.title):1!==this.fetchingLiveInfo.status?this.notification("同步失败",`该场次状态不正确，为${this.fetchingLiveInfo.status}：${this.fetchingLiveInfo.title}`):this.isOverTime(this.fetchingLiveInfo.startTime)?this.notification("同步失败","仅保留近30日开播场次数据，当前场次数据已清除："+this.fetchingLiveInfo.title):(this.notification("同步中","当前同步场次： "+this.fetchingLiveInfo.title),this.initStatus(),this.ongoing=!0,void this.loadIframe(e)):this.notification("同步失败",`该账号下未找 id 为 ${e} 的场次`)},async finish(){var e;this.notification("同步结束","已同步 "+this.fetchingLiveInfo.title),this.initStatus(),chrome.browserAction.setBadgeText({text:((this.liveToGet?this.liveToGet.length:"")||"")+""}),this.liveToGet.length&&(await(e=3e3,new Promise(i=>setTimeout(i,e))),this.run(this.liveToGet.shift()))},interceptWithErr(e){this.initStatus(),this.notification("同步中断，请记录下列报错并暂停同步","同步发生了一些问题："+e)}};chrome.webRequest.onBeforeSendHeaders.addListener(n.onBeforeSendHeaders.bind(n),{urls:["https://*/*","http://*/*"]},["blocking","requestHeaders","extraHeaders"]),chrome.storage.local.get(["liveList"],(function(e){console.log("get live list from store",e);try{n.liveList=JSON.parse(e.liveList)}catch(e){n.liveList=[]}})),console.log(n),chrome.runtime.onMessage.addListener((e,i,t)=>{console.log(i.tab?"from a content script:"+i.tab.url:"from the extension",e,i),"GET_ALL_LIVE"!==e.type&&"GET_SINGLE_LIVE"!==e.type||n.startSync(i.tab.id,e.data),t("")})}));
